<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#2f4595" />
<title>Registo de Cagarros / Cory's Shearwater Rescue</title>
<style>
  :root { --maxw:540px; --spea-blue:#2f4595; --ok:#28a745; --cta:#28a745; --muted:#dbe1ff; }
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0 auto;padding:18px;max-width:var(--maxw);background:var(--spea-blue);color:#fff}
  h2{ text-align:center;margin:8px 0 4px;line-height:1.2 }
  p.subtitle{ text-align:center;margin:0 0 10px;color:var(--muted);font-size:14px }
  .need{ text-align:center; font-size:12px; color:#cfe0ff; margin-bottom:10px }

  form{display:block}
  label{font-weight:700;display:block;margin-top:14px}
  select,input[type="text"],textarea,button{width:100%;padding:14px 12px;margin-top:6px;font-size:17px;border:1px solid #ced4da;border-radius:10px;background:#fff;color:#000}
  textarea{resize:vertical;min-height:84px}
  button{background:var(--cta);color:#fff;border:none;cursor:pointer;font-weight:800;min-height:48px;border-radius:12px}
  button.secondary{background:#0d6efd;margin-top:12px}
  button.ghost{background:transparent;border:2px solid #fff;color:#fff}
  button:disabled{background:#9ab6a0;cursor:not-allowed}

  .hint{font-size:12px;color:#f0f3ff;margin-top:6px}
  .hidden{display:none!important}
  .statusbar{margin:8px 0 10px;padding:10px;border-radius:10px;font-weight:700;text-align:center}
  .online{background:#e6f4ea;color:#1e7e34;border:1px solid #c7efd3}
  .offline{background:#fdecea;color:#a4252c;border:1px solid #f5c6cb}
  .queue{font-size:13px;text-align:center;color:#eee;margin-top:8px}

  /* C√≥digo gigante */
  .code-wrap{display:flex;justify-content:center;margin-top:12px}
  .code-box{
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size:clamp(2.4rem,10vw,3.8rem);line-height:1.1;
    background:#fff;border:3px dashed var(--ok);color:#0b7a2a;
    padding:16px 18px;border-radius:14px;user-select:all;text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,.2);min-width:78%;
  }
  .code-actions{display:flex;justify-content:center;gap:10px;margin-top:8px}
  .small-note{text-align:center;font-size:12px;color:var(--muted);margin-top:6px}

  /* Logo no fim (branco) */
  footer{margin:28px 0 6px;display:flex;justify-content:center}
  footer img.logo{max-width:190px;height:auto;filter: drop-shadow(0 2px 4px rgba(0,0,0,.25))}
</style>
</head>
<body>

<h2>Registo de Cagarros<br/>Cory's Shearwater Rescue</h2>
<p class="subtitle">Formul√°rio bilingue ‚Äî Portuguese / English</p>
<p class="need">Requisito de precis√£o do GPS: <strong>‚â§ 10 m</strong></p>

<div id="netStatus" class="statusbar hidden"></div>

<form id="cagarroForm" novalidate>
  <label for="nome">Nome / Name</label>
  <input type="text" id="nome" name="nome" placeholder="Digite o seu nome / Enter your name" required />

  <label for="estado">Estado / Status</label>
  <select id="estado" name="estado" required>
    <option value="">-- Escolher / Choose --</option>
    <option value="Vivo / Alive">Vivo / Alive</option>
    <option value="Morto / Dead">Morto / Dead</option>
    <option value="Ferido / Injured">Ferido / Injured</option>
    <option value="Oleado / Oiled">Oleado / Oiled</option>
  </select>

  <!-- Concelho (antes de Local) -->
  <label for="concelho">Concelho / Municipality</label>
  <select id="concelho" name="concelho" required>
    <option value="">‚Äî selecione / select ‚Äî</option>
    <option value="Nordeste">Nordeste</option>
    <option value="Povoa√ß√£o">Povoa√ß√£o</option>
    <option value="Faial da Terra">Faial da Terra</option>
    <option value="Outra">Outra / Other</option>
  </select>
  <div id="concelhoOutroWrap" class="hidden">
    <label for="concelhoOutro">Outro (especifique) / Other (specify)</label>
    <input id="concelhoOutro" name="concelhoOutro" placeholder="Ex.: √Ågua Retorta" />
  </div>

  <label for="local">Local / Location</label>
  <select id="local" name="local" required>
    <option value="">-- Selecionar / Select --</option>
    <option value="Sem localiza√ß√£o / No location">Sem localiza√ß√£o / No location</option>
    <option value="Hotel de Cagarro / Shearwater Hotel">Hotel de Cagarro / Shearwater Hotel</option>
    <option value="Fora da marina/Porto / Outside marina/Port">Fora da marina/Porto / Outside marina/Port</option>
  </select>

  <label for="observacoes">Observa√ß√µes / Observations</label>
  <textarea id="observacoes" name="observacoes" placeholder="Informa√ß√µes adicionais / Additional information"></textarea>

  <!-- GPS oculto -->
  <input type="hidden" id="latitude"  name="latitude" />
  <input type="hidden" id="longitude" name="longitude" />

  <button type="submit" id="sendBtn" disabled>üìç A obter GPS‚Ä¶ / Getting GPS‚Ä¶</button>
  <button type="button" id="refreshGps" class="ghost" style="margin-top:8px">üîÑ Atualizar GPS</button>
  <div id="gpsHint" class="hint"></div>
</form>

<button id="flushBtn" class="secondary hidden">üì§ Enviar Pendentes / Send Pending</button>
<div id="queueInfo" class="queue"></div>

<p id="mensagem"></p>
<div id="codeArea" class="hidden">
  <div class="code-wrap"><div id="bigCode" class="code-box" title="Toque para selecionar / Tap to select"></div></div>
  <div class="code-actions"><button id="copyBtn" class="ghost">üìã Copiar c√≥digo / Copy code</button></div>
  <div class="small-note">Guarde este c√≥digo. / Keep this code.</div>
</div>

<footer><img src="./spea-logo-white.png" alt="SPEA" class="logo" /></footer>

<script>
  // URL do Web App (Apps Script)
  const scriptURL = "https://script.google.com/macros/s/AKfycbxW4SkB3TVz-ZJ2MdQFjGjEGVv_jCg0sVckSxG3Tte1oSuAQOV9sg1CoUO19xxQiYqN/exec";

  // ===== GPS preciso (exige ‚â§ 10 m; bloqueia envio at√© atingir) =====
  document.addEventListener("DOMContentLoaded", () => {
    const REQUIRED_ACC = 10;         // metros
    const MAX_WINDOW   = 60000;      // ler durante no m√°x. 60 s
    const MIN_STABLE   = 2500;       // aguardar 2.5 s ap√≥s 1¬™ leitura
    const lat = document.getElementById("latitude");
    const lon = document.getElementById("longitude");
    const sendBtn = document.getElementById("sendBtn");
    const refreshBtn = document.getElementById("refreshGps");
    const hint = document.getElementById("gpsHint");

    let watchId = null;
    let best = null;
    let t0 = 0;

    function lockSend(msg){
      sendBtn.disabled = true;
      sendBtn.textContent = msg || "üìç A obter GPS‚Ä¶ / Getting GPS‚Ä¶";
    }
    function unlockSend(){
      sendBtn.disabled = false;
      sendBtn.textContent = "Enviar / Submit";
    }
    function setFix(f){
      lat.value = f.lat.toFixed(6);
      lon.value = f.lon.toFixed(6);
      hint.textContent = `Precis√£o: ¬±${Math.round(f.acc)} m` + (f.acc<=REQUIRED_ACC ? " ‚úÖ" : ` ‚Äî a melhorar at√© ‚â§ ${REQUIRED_ACC} m‚Ä¶`);
    }

    async function ensurePermission(){
      try{
        const st = await navigator.permissions.query({name:"geolocation"});
        if (st.state === "denied") hint.textContent = "‚ö†Ô∏è Localiza√ß√£o negada. Ative nas defini√ß√µes do browser/sistema.";
      }catch(_){}
    }

    function startGPS(){
      if (!("geolocation" in navigator)){
        hint.textContent = "Dispositivo sem geolocaliza√ß√£o.";
        return lockSend("Sem GPS");
      }
      ensurePermission();
      best = null; t0 = Date.now();
      lockSend("üìç A obter GPS‚Ä¶");
      hint.textContent = `A procurar sat√©lites (alvo ‚â§ ${REQUIRED_ACC} m)‚Ä¶`;

      try { if (watchId!==null) navigator.geolocation.clearWatch(watchId); } catch(_){}

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const acc = pos.coords.accuracy || 9999;
          const fix = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc };
          if (!best || acc < best.acc) { best = fix; setFix(best); }
          // aceitar quando ‚â§10 m e j√° passou um pouco
          if (acc <= REQUIRED_ACC && (Date.now()-t0) > MIN_STABLE){
            try { navigator.geolocation.clearWatch(watchId); } catch(_){}
            watchId = null;
            hint.textContent = `GPS ok: ¬±${Math.round(best.acc)} m ‚úÖ`;
            unlockSend();
          }
        },
        (err) => {
          try { if (watchId!==null) navigator.geolocation.clearWatch(watchId); } catch(_){}
          watchId = null;
          hint.textContent = `Sem GPS preciso (${err.message}). Tenta novamente.`;
          lockSend("GPS indispon√≠vel");
        },
        { enableHighAccuracy: true, timeout: MAX_WINDOW, maximumAge: 0 }
      );

      // timeout global
      setTimeout(() => {
        if (watchId!==null){
          try { navigator.geolocation.clearWatch(watchId); } catch(_){}
          watchId = null;
        }
        if (best){
          setFix(best);
          if (best.acc <= REQUIRED_ACC){
            hint.textContent = `GPS ok: ¬±${Math.round(best.acc)} m ‚úÖ`;
            unlockSend();
          } else {
            hint.textContent = `‚è±Ô∏è Timeout: melhor obtido ¬±${Math.round(best.acc)} m (> ${REQUIRED_ACC} m). Carrega em "Atualizar GPS" e espera ao ar livre.`;
            lockSend("Precis√£o insuficiente");
          }
        } else {
          hint.textContent = "‚è±Ô∏è Timeout sem leituras. Verifica permiss√µes e tenta de novo.";
          lockSend("Sem leituras");
        }
      }, MAX_WINDOW);
    }

    // primeir a tentativa
    startGPS();
    refreshBtn.addEventListener("click", startGPS);
  });

  // ===== Concelho ‚Üí ‚ÄúOutra‚Äù =====
  const selCon=document.getElementById("concelho");
  const wrapOu=document.getElementById("concelhoOutroWrap");
  const inpOu=document.getElementById("concelhoOutro");
  selCon?.addEventListener("change",()=>{ const outra=selCon.value==="Outra"; wrapOu.classList.toggle("hidden",!outra); inpOu.required=outra; if(!outra) inpOu.value=""; });

  // ===== Offline queue =====
  const LS_KEY="cagarros_pendentes_v1";
  const netBar=document.getElementById("netStatus");
  const flushBtn=document.getElementById("flushBtn");
  const queueInfo=document.getElementById("queueInfo");
  function getQueue(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||"[]")}catch(_){return[]} }
  function setQueue(a){ localStorage.setItem(LS_KEY,JSON.stringify(a)); updateQueueUI(); }
  function addPending(p){ const q=getQueue(); q.push({payload:p,savedAt:new Date().toISOString()}); setQueue(q); }
  function updateQueueUI(){ const n=getQueue().length; queueInfo.textContent=n>0?`üóÇÔ∏è Pendentes: ${n}`:""; flushBtn.classList.toggle("hidden",n===0); }
  function setNetBar(){ netBar.classList.remove("hidden"); if(navigator.onLine){ netBar.className="statusbar online"; netBar.textContent="Liga√ß√£o ativa / Online"; } else { netBar.className="statusbar offline"; netBar.textContent="Sem rede ‚Äî pendentes / Offline ‚Äî will be queued"; } }
  window.addEventListener("online",()=>{ setNetBar(); flushPending(); }); window.addEventListener("offline",setNetBar);
  setNetBar(); updateQueueUI();

  // ===== C√≥digo UI + Submiss√£o =====
  const codeArea=document.getElementById("codeArea");
  const bigCode=document.getElementById("bigCode");
  const copyBtn=document.getElementById("copyBtn");

  document.getElementById("cagarroForm").addEventListener("submit",async(e)=>{
    e.preventDefault();
    if (selCon.value==="Outra" && !inpOu.value.trim()){ inpOu.focus(); return; }

    const btn=document.getElementById("sendBtn");
    const msg=document.getElementById("mensagem");
    btn.disabled=true; btn.textContent="A enviar... / Sending...";
    codeArea.classList.add("hidden"); bigCode.textContent="";

    const payload={
      nome:document.getElementById("nome").value,
      estado:document.getElementById("estado").value,
      concelho:document.getElementById("concelho").value,
      concelhoOutro:document.getElementById("concelhoOutro")?.value||"",
      local:document.getElementById("local").value,
      observacoes:document.getElementById("observacoes").value,
      latitude:document.getElementById("latitude").value,
      longitude:document.getElementById("longitude").value
    };

    try{
      const res=await fetch(scriptURL,{method:"POST",body:JSON.stringify(payload)});
      const text=await res.text(); let data=null; try{ data=JSON.parse(text);}catch(_){}
      if(res.ok && data && data.status==="success"){
        msg.textContent="‚úÖ Registo enviado! / Entry submitted!";
        bigCode.textContent=data.codigo||"";
        codeArea.classList.remove("hidden");
        e.target.reset();
      } else {
        addPending(payload);
        msg.innerHTML="‚ö†Ô∏è N√£o foi poss√≠vel gravar agora. Guardado em Pendentes.";
      }
    } catch {
      addPending(payload);
      document.getElementById("mensagem").textContent="üì¶ Sem rede: guardado em Pendentes / Saved offline.";
    } finally {
      btn.disabled=false; btn.textContent="Enviar / Submit";
    }
  });

  async function flushPending(){
    if(!navigator.onLine) return;
    const q=getQueue(); if(q.length===0) return;
    flushBtn.disabled=true; flushBtn.textContent="A enviar pendentes... / Sending...";
    let ok=0,fail=0; const newQ=[];
    for(const item of q){
      try{ const res=await fetch(scriptURL,{method:"POST",body:JSON.stringify(item.payload)}); if(res.ok) ok++; else {fail++; newQ.push(item);} }
      catch(_){ fail++; newQ.push(item); }
    }
    setQueue(newQ);
    flushBtn.disabled=false; flushBtn.textContent="üì§ Enviar Pendentes / Send Pending";
    const msg=document.getElementById("mensagem");
    if(ok>0) msg.textContent=`üì§ Enviados: ${ok} | Por enviar: ${newQ.length}`;
    if(fail>0 && ok===0) msg.textContent="‚ö†Ô∏è Falha ao enviar pendentes.";
  }
  document.getElementById("flushBtn").addEventListener("click",flushPending);

  copyBtn.addEventListener("click",async(ev)=>{
    ev.preventDefault();
    const code=bigCode.textContent.trim(); if(!code) return;
    try{ await navigator.clipboard.writeText(code); const old=copyBtn.textContent; copyBtn.textContent="‚úÖ Copiado!"; setTimeout(()=>copyBtn.textContent=old,1400); }
    catch(_){ const r=document.createRange(); r.selectNodeContents(bigCode); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r); }
  });
  bigCode.addEventListener("click",()=>{
    const r=document.createRange(); r.selectNodeContents(bigCode);
    const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
  });
</script>
</body>
</html>
