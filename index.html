<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registos de Cagarros — Terras do Priolo</title>
<style>
  :root { --bg:#0b1320; --card:#121a2b; --muted:#94a3b8; --acc:#58c4b5; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(180deg,#0b1320,#0f1a33);color:#e5e7eb}
  header{padding:28px 16px;text-align:center}
  header h1{margin:0 0 6px;font-weight:800}
  header p{margin:0;color:var(--muted)}
  main{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:18px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  label{font-weight:600;margin-bottom:6px;display:block}
  input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:#e2e8f0}
  select{cursor:pointer}
  small{color:var(--muted)}
  .row{display:flex;gap:12px}
  .row > *{flex:1}
  .hint{font-size:.9rem;color:var(--muted)}
  .success{margin-top:14px;padding:12px;border-radius:12px;background:#0f2a1c;border:1px solid #1e4d36}
  .error{margin-top:14px;padding:12px;border-radius:12px;background:#2a0f13;border:1px solid #4d1e27}
  .btn{background:var(--acc);border:none;color:#06231f;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <h1>Registos de Cagarros — Terras do Priolo</h1>
  <p>Ajude-nos a registar observações nas Terras do Priolo</p>
</header>

<main>
  <div class="card">
    <iframe name="submitSink" id="submitSink" style="display:none"></iframe>

    <form id="formRegisto" method="POST"
          action="https://script.google.com/macros/s/AKfycbzYSWc1pumdviFhmwsoXc5kICQS5uRiXrX0Vj_wRQ4fDtuQw9j0QjHOPw3np2aDZ_CU/exec"
          target="submitSink" autocomplete="on">

      <div class="grid">
        <div>
          <label for="nome">Nome / Name</label>
          <input id="nome" name="nome" placeholder="Ex.: Ana Mendes" required>
          <small class="hint">O seu nome ou da equipa.</small>
        </div>

        <div>
          <label for="estado">Estado da ave / Bird status</label>
          <select id="estado" name="estado" required>
            <option value="" disabled selected>— selecione —</option>
            <option value="Vivo (saudável)">Vivo (saudável)</option>
            <option value="Vivo (ferido)">Vivo (ferido)</option>
            <option value="Morto">Morto</option>
            <option value="Libertado">Libertado</option>
          </select>
        </div>

        <div>
          <label for="local"><strong>Local</strong></label>
          <select id="local" name="local" required>
            <option value="" selected disabled>— selecione —</option>
            <option value="Sem localização">Sem localização</option>
            <option value="Hotel de Cagarro">Hotel de Cagarro</option>
            <option value="Fora da marina/Porto">Fora da marina/Porto</option>
          </select>
        </div>

        <div>
          <label for="concelho"><strong>Concelho</strong></label>
          <select id="concelho" name="concelho" required>
            <option value="" selected disabled>— selecione —</option>
            <option value="Nordeste">Nordeste</option>
            <option value="Povoação">Povoação</option>
            <option value="Faial da Terra">Faial da Terra</option>
            <option value="Outra">Outra</option>
          </select>
        </div>

        <div id="concelhoOutroWrap" style="display:none">
          <label for="concelhoOutro">Outro (especifique)</label>
          <input id="concelhoOutro" name="concelhoOutro" placeholder="Ex.: Água Retorta">
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="observacoes">Observações</label>
        <textarea id="observacoes" name="observacoes" rows="3" placeholder="Opcional"></textarea>
      </div>

      <!-- Ocultos (auto) -->
      <input type="hidden" id="latitude"   name="latitude"   value="">
      <input type="hidden" id="longitude"  name="longitude"  value="">
      <input type="hidden" id="faseLuaPct" name="faseLuaPct" value="">
      <input type="hidden" id="faseLua"    name="faseLua"    value="">
      <input type="hidden" id="clientKey"  name="clientKey"  value="">

      <div class="row" style="margin-top:10px">
        <button id="btnEnviar" class="btn" type="submit">Enviar registo</button>
      </div>

      <div id="msg" class="success" style="display:none">
        <div><strong>Obrigado!</strong> Código do registo: <span id="idGerado"></span></div>
      </div>
      <div id="msgErr" class="error" style="display:none">
        <div><strong>Falha no envio.</strong> Tente novamente.</div>
      </div>
    </form>
  </div>
</main>

<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzYSWc1pumdviFhmwsoXc5kICQS5uRiXrX0Vj_wRQ4fDtuQw9j0QjHOPw3np2aDZ_CU/exec';

  // Geolocalização (oculta)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        document.getElementById('latitude').value = latitude.toFixed(6);
        document.getElementById('longitude').value = longitude.toFixed(6);
      }, () => {}, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 }
    );
  }

  // Fase da lua (oculta)
  function moonInfo(date=new Date()){
    const synodic=29.53058867, known=Date.UTC(2000,0,6,18,14);
    const days=(date.getTime()-known)/86400000, lun=days/synodic;
    const d=(lun-Math.floor(lun))*synodic, ph=(lun-Math.floor(lun))*2*Math.PI;
    const pct=Math.round(((1-Math.cos(ph))/2)*100);
    let nome='Nova';
    if (d<1.84566) nome='Nova';
    else if (d<5.53699) nome='Crescente';
    else if (d<9.22831) nome='Quarto Crescente';
    else if (d<12.91963) nome='Gibosa Crescente';
    else if (d<16.61096) nome='Cheia';
    else if (d<20.30228) nome='Gibosa Minguante';
    else if (d<23.99361) nome='Quarto Minguante';
    else if (d<27.68493) nome='Minguante';
    else nome='Nova';
    return { pct, nome };
  }
  (function(){ const {pct,nome}=moonInfo();
    document.getElementById('faseLuaPct').value=pct;
    document.getElementById('faseLua').value=nome;
  })();

  // Concelho -> Outra
  const selCon = document.getElementById('concelho');
  const wrapOu = document.getElementById('concelhoOutroWrap');
  const inpOu  = document.getElementById('concelhoOutro');
  selCon.addEventListener('change', ()=> {
    const outra = selCon.value==='Outra';
    wrapOu.style.display = outra?'block':'none';
    inpOu.required = outra;
    if (!outra) inpOu.value = '';
  });

  // Util JSONP
  function jsonp(url, cb){
    const cbName='__cb'+Math.random().toString(36).slice(2);
    window[cbName]=function(data){ try{cb(data)}finally{ delete window[cbName]; if(s&&s.parentNode) s.parentNode.removeChild(s); } };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cbName+'&t='+Date.now();
    s.async=true; document.body.appendChild(s);
  }

  // UI envio + obtenção do ID
  const form = document.getElementById('formRegisto');
  const btn  = document.getElementById('btnEnviar');
  const msg  = document.getElementById('msg');
  const err  = document.getElementById('msgErr');
  const idEl = document.getElementById('idGerado');

  // Token único deste envio
  function newClientKey(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }

  form.addEventListener('submit', (e) => {
    if (selCon.value === 'Outra' && !inpOu.value.trim()) {
      e.preventDefault(); inpOu.focus(); return;
    }
    // gerar token e guardar em campo oculto
    const key = newClientKey();
    document.getElementById('clientKey').value = key;

    msg.style.display='none'; err.style.display='none';
    btn.disabled=true; btn.textContent='A enviar…';

    // Poll via JSONP até obter o ID associado ao token (máx. 20s)
    let elapsed = 0;
    const tick = 700; // ms
    const timer = setInterval(() => {
      elapsed += tick;
      jsonp(WEBAPP_URL + '?find=' + encodeURIComponent(key), (data) => {
        if (data && data.ok && data.id) {
          clearInterval(timer);
          idEl.textContent = data.id;
          msg.style.display='block';
          btn.disabled=false; btn.textContent='Enviar registo';
          form.reset(); wrapOu.style.display='none'; inpOu.required=false;
        }
      });
      if (elapsed >= 20000) { // timeout
        clearInterval(timer);
        idEl.textContent = '(enviado)';
        msg.style.display='block';
        btn.disabled=false; btn.textContent='Enviar registo';
        form.reset(); wrapOu.style.display='none'; inpOu.required=false;
      }
    }, tick);
  });

  // Recebe também via postMessage, se disponível (mais rápido)
  window.addEventListener('message', (evt) => {
    let data = evt.data;
    if (typeof data === 'string') { try { data = JSON.parse(data); } catch(_) {} }
    if (data && data.ok && data.id) {
      idEl.textContent = data.id;
      msg.style.display='block';
      btn.disabled=false; btn.textContent='Enviar registo';
      form.reset(); wrapOu.style.display='none'; inpOu.required=false;
    }
  });
</script>
</body>
</html>
